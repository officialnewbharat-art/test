<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internanda AI Interviewer - Interna</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Tailwind Configuration */
        :root {
            --primary: #1e40af; /* Blue-700 */
            --secondary: #6366f1; /* Indigo-500 */
            --accent: #3b82f6; /* Blue-500 */
            --bg-dark: #0f172a; /* Slate-900 */
            --bg-light: #f1f5f9; /* Slate-100 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #e2e8f0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        /* Glassmorphism Card Style */
        .glass-card {
            background: rgba(30, 41, 59, 0.7); /* Slate-800 with transparency */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(100, 116, 139, 0.3); /* Slate-500 border */
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Robot Avatar and Animations */
        #robot-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: var(--primary);
            border: 5px solid var(--accent);
            position: relative;
            margin: 0 auto 1.5rem;
            box-shadow: 0 0 40px var(--accent);
            transition: all 0.3s ease;
        }

        /* Robot Face Elements */
        .robot-eye {
            width: 15px;
            height: 15px;
            background: #fff;
            border-radius: 50%;
            position: absolute;
            top: 45px;
            transform: translateY(-50%);
            transition: background 0.3s;
        }
        #eye-left { left: 45px; }
        #eye-right { right: 45px; }

        /* Robot Mouth / Waveform */
        #robot-mouth {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 10px;
            background-color: #fca5a5; /* Red for visibility */
            border-radius: 5px;
            transition: all 0.1s ease-out;
            opacity: 0;
        }

        /* Animation: Speaking (Mouth Movement) */
        @keyframes speaking {
            0%, 100% { height: 10px; background-color: #fca5a5; }
            25% { height: 15px; background-color: #fecaca; }
            50% { height: 5px; background-color: #fca5a5; }
            75% { height: 18px; background-color: #fecaca; }
        }
        .speaking #robot-mouth {
            opacity: 1;
            animation: speaking 0.4s infinite alternate;
        }

        /* Animation: Listening (Pulsing Mic/Waves) */
        @keyframes listening-pulse {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .listening #robot-avatar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            border: 3px solid var(--accent);
            animation: listening-pulse 1.5s infinite ease-out;
            pointer-events: none;
        }
        .listening #robot-avatar .robot-eye {
            background: #fef08a; /* Yellow for listening */
        }
        .listening #robot-mouth {
             background: #bbf7d0; /* Green for listening */
             opacity: 1;
        }

        /* Transcription/Chat Bubbles */
        .chat-bubble {
            max-width: 90%;
            padding: 0.75rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .interna-bubble {
            background-color: rgba(30, 41, 59, 0.9); /* Darker blue */
            border-left: 4px solid var(--accent);
            margin-right: auto;
        }
        .candidate-bubble {
            background-color: rgba(71, 85, 105, 0.9); /* Slate-600 */
            border-right: 4px solid #f97316; /* Orange-500 */
            margin-left: auto;
            text-align: right;
        }

        /* Print Styles for PDF Download */
        @media print {
            body {
                background: white;
                color: #333;
                font-size: 10pt;
                padding: 0;
            }
            .no-print {
                display: none !important;
            }
            #app-container {
                box-shadow: none;
                max-width: 100%;
                margin: 0;
                padding: 0;
                border: none;
                backdrop-filter: none;
                background: white;
                color: #333;
            }
            #results-section {
                padding: 1rem;
            }
            h1, h2, h3 {
                color: #1e40af;
            }
            .glass-card {
                background: #f0f0f0 !important;
                border: 1px solid #ccc !important;
                box-shadow: none !important;
                margin-bottom: 1rem;
            }
            .text-5xl { font-size: 2.5rem; }
            .text-3xl { font-size: 1.5rem; }
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <!-- Main Application Container -->
    <div id="app-container" class="glass-card w-full max-w-4xl p-6 md:p-10 transition-all duration-500">

        <!-- Initial Setup Screen -->
        <section id="intro-section" class="space-y-6">
            <h1 class="text-3xl font-bold text-center text-white">
                <span class="text-accent">Interna</span>: AI Interview Agent
            </h1>
            <p class="text-center text-slate-400">
                Welcome to your fully voice-driven interview for Internanda. Please fill in your details to begin.
            </p>

            <!-- API Warning -->
            <div class="bg-red-900/50 p-4 rounded-lg border border-red-700/50 text-sm text-red-300">
                <p class="font-semibold">⚠️ API Key Warning:</p>
                <p>This application is designed to run locally. Ensure you provide a valid Gemini API key in the JavaScript code to enable the AI functionality.</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="candidate-name" class="block text-sm font-medium text-slate-300 mb-1">Candidate Name</label>
                    <input type="text" id="candidate-name" value="Candidate"
                           class="w-full p-3 rounded-lg bg-slate-700/50 border border-slate-600 focus:ring-accent focus:border-accent text-white"
                           placeholder="Enter your name">
                </div>
                <div>
                    <label for="role-applied-for" class="block text-sm font-medium text-slate-300 mb-1">Role Applied For</label>
                    <input type="text" id="role-applied-for" value="Intern"
                           class="w-full p-3 rounded-lg bg-slate-700/50 border border-slate-600 focus:ring-accent focus:border-accent text-white"
                           placeholder="e.g., Software Intern, Marketing Intern">
                </div>
            </div>

            <button onclick="startInterview()"
                    class="w-full py-3 mt-4 text-lg font-semibold rounded-lg bg-accent hover:bg-blue-600 transition duration-200 shadow-lg shadow-accent/50">
                Start Interview
            </button>
        </section>

        <!-- Live Interview Screen -->
        <section id="interview-section" class="hidden">
            <div class="flex flex-col md:flex-row gap-6">

                <!-- Left Panel: Robot & Controls -->
                <div class="md:w-1/3 flex flex-col items-center p-4 glass-card bg-slate-800/80">
                    <h2 class="text-xl font-semibold mb-4 text-center">Interna: The Interviewer</h2>

                    <!-- Robot Avatar -->
                    <div id="robot-avatar" class="flex items-center justify-center">
                        <div class="robot-eye" id="eye-left"></div>
                        <div class="robot-eye" id="eye-right"></div>
                        <div id="robot-mouth"></div>
                    </div>

                    <p id="status-message" class="text-lg font-medium text-center h-8 my-2 text-yellow-400">Initializing...</p>

                    <!-- Timer -->
                    <div class="mt-4 p-2 bg-slate-700/50 rounded-lg text-center w-full">
                        <span class="text-sm text-slate-400 block">TIME LEFT (10:00)</span>
                        <div id="interview-timer" class="text-3xl font-mono text-accent">10:00</div>
                    </div>

                    <!-- End Button -->
                    <button onclick="endInterview(true)"
                            id="end-session-btn"
                            class="w-full py-3 mt-6 text-md font-semibold rounded-lg bg-red-600 hover:bg-red-700 transition duration-200 shadow-lg shadow-red-600/50 flex items-center justify-center gap-2"
                            disabled>
                        <i data-lucide="power"></i>
                        End Session
                    </button>
                    <p class="text-xs mt-2 text-slate-500 text-center">The interview will auto-end after 10 minutes.</p>
                </div>

                <!-- Right Panel: Transcript & Analysis -->
                <div class="md:w-2/3 h-[600px] flex flex-col">
                    <h2 class="text-xl font-semibold mb-4 text-white">Live Transcript & Evaluation</h2>
                    <div id="transcript-panel" class="flex-grow overflow-y-auto p-4 space-y-4 glass-card bg-slate-800/80">
                        <!-- Chat bubbles will be inserted here -->
                        <div class="text-center text-slate-500 italic p-4">Transcript will appear here.</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Final Results Screen -->
        <section id="results-section" class="hidden space-y-6">
            <h1 class="text-4xl font-extrabold text-center text-white">
                Interview <span class="text-accent">Completed</span>
            </h1>

            <!-- Overall Score Card -->
            <div class="glass-card p-6 flex flex-col items-center bg-slate-800/80">
                <h2 class="text-2xl font-semibold text-slate-300 mb-2">Final Evaluation Score</h2>
                <div id="final-score" class="text-7xl font-mono font-extrabold text-accent">--</div>
                <p id="final-verdict" class="mt-4 text-xl font-bold"></p>
                <div id="final-deductions" class="mt-4 w-full max-w-xl text-center">
                    <h3 class="text-lg font-semibold text-slate-400 mb-2">Overall Deduction Reasons:</h3>
                    <ul id="deduction-list" class="list-disc list-inside text-sm text-slate-300 text-left mx-auto">
                        <!-- Deduction reasons will be listed here -->
                    </ul>
                </div>
            </div>

            <!-- Detailed Breakdown -->
            <h2 class="text-2xl font-bold text-slate-300 mt-8">Question Breakdown</h2>
            <div id="breakdown-panel" class="space-y-6">
                <!-- Detailed results per question will be inserted here -->
            </div>

            <!-- Action Buttons (No Print) -->
            <div class="no-print flex flex-col sm:flex-row justify-center gap-4 mt-8">
                <button onclick="downloadResults('json')"
                        class="py-3 px-6 text-lg font-semibold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition duration-200 shadow-lg shadow-indigo-600/50 flex items-center justify-center gap-2">
                    <i data-lucide="download"></i> Download JSON
                </button>
                <button onclick="downloadResults('pdf')"
                        class="py-3 px-6 text-lg font-semibold rounded-lg bg-green-600 hover:bg-green-700 transition duration-200 shadow-lg shadow-green-600/50 flex items-center justify-center gap-2">
                    <i data-lucide="printer"></i> Print/Download PDF
                </button>
                <button onclick="location.reload()"
                        class="py-3 px-6 text-lg font-semibold rounded-lg bg-slate-600 hover:bg-slate-700 transition duration-200 flex items-center justify-center gap-2">
                    <i data-lucide="rotate-ccw"></i> Restart Interview
                </button>
            </div>
        </section>

        <!-- Debug Panel Toggle -->
        <div class="no-print mt-6 text-center">
            <button onclick="toggleDebugPanel()" class="text-xs text-slate-500 hover:text-accent transition duration-200">
                Toggle Debug Panel
            </button>
            <div id="debug-panel" class="hidden mt-2 p-4 bg-slate-900 rounded-lg text-xs text-left overflow-x-auto">
                <h3 class="font-bold text-slate-300 mb-2">Gemini API Calls Log:</h3>
                <pre id="debug-log" class="whitespace-pre-wrap text-slate-400"></pre>
            </div>
        </div>

    </div>

    <script type="module">
        // --- GLOBAL CONFIGURATION AND CONSTANTS ---

        // IMPORTANT: Replace this with your actual Gemini API Key
        const GEMINI_API_KEY = "";
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
        const MAX_INTERVIEW_TIME_SECONDS = 600; // 10 minutes

        // Firebase-like environment variables (Mandatory for Canvas setup, even if Firestore isn't used)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Ensure Lucide icons are rendered
        lucide.createIcons();
        
        // --- GLOBAL STATE ---
        let candidateName = "";
        let roleAppliedFor = "";
        let interviewLog = []; // Stores { type: 'question'|'answer'|'evaluation', text: '...', data: {} }
        let currentQuestion = null;
        let isSpeaking = false;
        let isListening = false;
        let isInterviewActive = false;
        let interviewTimer = null;
        let secondsRemaining = MAX_INTERVIEW_TIME_SECONDS;

        // Speech Synthesis and Recognition setup
        const synth = window.speechSynthesis;
        const recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let speechRecognition = recognition ? new recognition() : null;
        if (speechRecognition) {
            speechRecognition.continuous = false;
            speechRecognition.interimResults = false;
            speechRecognition.lang = 'en-US';
        }

        // --- GEMINI PROMPT TEMPLATES ---

        // A) Question Generator System Prompt
        const QUESTION_SYSTEM_PROMPT = (role, history) => {
            const historyText = history.map(item => {
                if (item.type === 'question') return `Q: ${item.text}`;
                if (item.type === 'answer') return `A: ${item.text}`;
                return '';
            }).join('\n');

            return `You are Interna, an AI interviewer for the role of ${role}. Your task is to generate the next question for the candidate, ${candidateName}.
1. The questions should progress logically from general/behavioral (motivation, fit) to simple-to-moderate technical questions suitable for an intern level.
2. Do NOT repeat questions or topics already covered.
3. The response must be *only* the question text, starting with a capital letter and ending with a question mark. Do not include 'Interna says:', 'Next question:', or any other conversational prefix.
4. If the interview history has 5 or more questions, generate a brief, final concluding question (e.g., "Do you have any questions for me?") or state the exact string "INTERVIEW_COMPLETE" to signal the end of the interview.

--- Interview History ---
${historyText}`;
        };

        // B) Answer Evaluator JSON Schema
        const EVALUATION_SCHEMA = {
            type: "OBJECT",
            properties: {
                score: { type: "INTEGER", description: "The candidate's score for this answer (1-10), with 10 being perfect." },
                summary: { type: "STRING", description: "A concise, objective summary of the candidate's answer." },
                strengths: { type: "ARRAY", items: { type: "STRING" }, description: "List of 1-2 key strengths of the answer (e.g., clarity, depth, relevance)." },
                weaknesses: { type: "ARRAY", items: { type: "STRING" }, description: "List of 1-2 key weaknesses or areas for improvement (e.g., vagueness, missing key points)." },
                deductions: { type: "ARRAY", items: { type: "STRING" }, description: "Specific, clear reasons for point deductions. Must explain *why* points were lost (e.g., 'Lacked concrete examples,' 'Did not address the technical aspect')." }
            },
            required: ["score", "summary", "strengths", "weaknesses", "deductions"]
        };

        // C) Answer Evaluator System Prompt
        const EVALUATION_SYSTEM_PROMPT = (question, role) => `You are Interna, a professional hiring manager robot. You must evaluate the candidate's transcribed answer for the role of ${role}.
The question was: "${question}".
1. Be critical but fair, assigning a score from 1 to 10 based on relevance, clarity, and depth for an intern-level answer.
2. Output a single, strict JSON object following the provided schema. Do not add any text outside the JSON object.`;


        // --- UI & ANIMATION FUNCTIONS ---

        const robotAvatar = document.getElementById('robot-avatar');
        const statusMessage = document.getElementById('status-message');
        const transcriptPanel = document.getElementById('transcript-panel');
        const timerDisplay = document.getElementById('interview-timer');
        const endSessionBtn = document.getElementById('end-session-btn');
        const debugLog = document.getElementById('debug-log');
        const debugPanel = document.getElementById('debug-panel');

        function updateRobotState(state) { // 'speaking', 'listening', 'idle'
            isSpeaking = state === 'speaking';
            isListening = state === 'listening';

            robotAvatar.className = 'flex items-center justify-center';
            statusMessage.textContent = '';
            endSessionBtn.disabled = isSpeaking || isListening;

            if (isSpeaking) {
                robotAvatar.classList.add('speaking');
                statusMessage.textContent = 'Interna is Speaking...';
                statusMessage.classList.remove('text-green-400');
                statusMessage.classList.add('text-yellow-400');
            } else if (isListening) {
                robotAvatar.classList.add('listening');
                statusMessage.textContent = 'Candidate is Speaking...';
                statusMessage.classList.remove('text-yellow-400');
                statusMessage.classList.add('text-green-400');
            } else {
                statusMessage.textContent = 'Waiting for next question.';
                statusMessage.classList.remove('text-yellow-400', 'text-green-400');
            }
        }

        function toggleDebugPanel() {
            debugPanel.classList.toggle('hidden');
        }

        function logDebug(title, payload, response) {
            const time = new Date().toLocaleTimeString();
            debugLog.innerHTML += `
<hr class="my-2 border-slate-700">
<p class="font-bold text-accent">[${time}] ${title}</p>
<p class="mt-1 text-slate-500">REQUEST:</p>
<pre>${JSON.stringify(payload, null, 2)}</pre>
<p class="mt-1 text-slate-500">RESPONSE:</p>
<pre>${JSON.stringify(response, null, 2)}</pre>
`;
            debugPanel.scrollTop = debugPanel.scrollHeight;
        }

        function appendTranscript(type, text, data = null) {
            let bubble = document.createElement('div');
            bubble.className = `chat-bubble ${type === 'interna' ? 'interna-bubble' : 'candidate-bubble'}`;
            
            if (type === 'interna') {
                bubble.innerHTML = `<span class="font-bold text-accent">Interna:</span> ${text}`;
                interviewLog.push({ type: 'question', text: text, data: data });
                currentQuestion = text; // Set the current question
            } else {
                bubble.innerHTML = `<span class="font-bold text-orange-400">You:</span> ${text}`;
                interviewLog.push({ type: 'answer', text: text, data: data });
            }

            transcriptPanel.appendChild(bubble);
            transcriptPanel.scrollTop = transcriptPanel.scrollHeight;
        }

        function appendEvaluation(evaluation) {
            let evalHtml = `
                <div class="p-4 rounded-lg bg-slate-700/50 border border-slate-600 space-y-2 my-2">
                    <h4 class="font-bold text-lg text-white flex justify-between items-center">
                        Question ${interviewLog.filter(i => i.type === 'evaluation').length + 1} Evaluation
                        <span class="text-3xl font-mono ${evaluation.score >= 7 ? 'text-green-400' : evaluation.score >= 4 ? 'text-yellow-400' : 'text-red-400'}">${evaluation.score}/10</span>
                    </h4>
                    <p class="text-sm italic text-slate-400 border-b border-slate-700 pb-2">Summary: ${evaluation.summary}</p>
                    
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="w-full sm:w-1/2">
                            <h5 class="font-semibold text-green-300">Strengths:</h5>
                            <ul class="list-disc list-inside text-sm text-green-200">
                                ${evaluation.strengths.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="w-full sm:w-1/2">
                            <h5 class="font-semibold text-red-300">Weaknesses / Deductions:</h5>
                            <ul class="list-disc list-inside text-sm text-red-200">
                                ${evaluation.deductions.map(d => `<li class="text-red-400">${d}</li>`).join('')}
                                ${evaluation.weaknesses.filter(w => !evaluation.deductions.includes(w)).map(w => `<li>${w}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            let bubble = document.createElement('div');
            bubble.innerHTML = evalHtml;
            transcriptPanel.appendChild(bubble);
            transcriptPanel.scrollTop = transcriptPanel.scrollHeight;

            interviewLog.push({ type: 'evaluation', text: 'Evaluation complete.', data: evaluation });
        }


        // --- SPEECH INTERACTION ---

        function speak(text) {
            if (isSpeaking) return;

            return new Promise((resolve) => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.voice = synth.getVoices().find(v => v.lang.startsWith('en')) || synth.getVoices()[0]; // Use an English voice
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                
                utterance.onstart = () => {
                    updateRobotState('speaking');
                };
                utterance.onend = () => {
                    updateRobotState('idle');
                    resolve();
                };
                utterance.onerror = (e) => {
                    console.error('Speech synthesis error:', e);
                    updateRobotState('idle');
                    resolve(); // Resolve anyway to unblock the flow
                };
                synth.speak(utterance);
            });
        }

        function startListening() {
            if (!speechRecognition || isListening) return;

            return new Promise((resolve, reject) => {
                speechRecognition.onresult = (event) => {
                    const transcript = Array.from(event.results)
                        .map(result => result[0].transcript)
                        .join('');
                    resolve(transcript);
                };

                speechRecognition.onerror = (event) => {
                    if (event.error !== 'no-speech' && event.error !== 'aborted') {
                        console.error('Speech recognition error:', event.error);
                        alert(`Voice Input Error: ${event.error}. Please try speaking again or check microphone permissions.`);
                        reject(`Speech recognition error: ${event.error}`);
                    } else {
                        // Resolve with empty string if no speech was detected (user paused/stopped talking)
                        resolve(""); 
                    }
                };

                speechRecognition.onend = () => {
                    updateRobotState('idle');
                };

                try {
                    updateRobotState('listening');
                    speechRecognition.start();
                } catch (e) {
                    console.error('Recognition start error:', e);
                    reject(e);
                }
            })
            .then(transcript => {
                if (transcript.trim() === "") {
                    // If no speech was detected, Interna prompts the user to speak
                    speak("I didn't quite catch that. Please try to state your answer again.")
                        .then(() => {
                            // After speaking the prompt, immediately restart listening
                            startListening().then(handleAnswer).catch(console.error);
                        });
                } else {
                    handleAnswer(transcript);
                }
            })
            .catch(error => {
                console.error("Listening flow failed:", error);
                // If a critical error occurred, wait and attempt next question flow
                setTimeout(askNextQuestion, 2000); 
            });
        }
        
        // --- GEMINI API CALL HANDLERS ---

        async function callGemini(systemPrompt, userQuery, responseSchema = null, title = "API Call") {
            if (!GEMINI_API_KEY) {
                console.error("GEMINI_API_KEY is missing. Cannot proceed with AI.");
                return { error: "API Key Missing." };
            }

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                config: {
                    responseMimeType: responseSchema ? "application/json" : undefined,
                    responseSchema: responseSchema || undefined,
                },
            };

            let response = null;
            let result = null;
            let attempts = 0;
            const maxRetries = 3;

            while (attempts < maxRetries) {
                attempts++;
                try {
                    response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        result = await response.json();
                        logDebug(title, payload, result);
                        const textPart = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        return textPart ? textPart : (responseSchema ? "{}" : "No content returned.");
                    } else if (response.status === 429) {
                        // Rate limit error, implement exponential backoff
                        const delay = Math.pow(2, attempts) * 1000;
                        console.warn(`Attempt ${attempts}: Rate limit hit. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // Other HTTP error
                        const errorText = await response.text();
                        console.error(`Gemini API HTTP Error (${response.status}): ${errorText}`);
                        return { error: `HTTP Error: ${response.status} - ${errorText}` };
                    }
                } catch (e) {
                    // Network or JSON parsing error
                    console.error(`Attempt ${attempts}: Network or JSON error.`, e);
                    if (attempts === maxRetries) return { error: `Fetch failed: ${e.message}` };
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempts)); // Simple backoff
                }
            }
            return { error: "Failed after max retries." };
        }

        async function generateQuestion() {
            const currentQuestions = interviewLog.filter(i => i.type === 'question').length;
            const userQuery = `Generate the next interview question for the role: ${roleAppliedFor}. Question count so far: ${currentQuestions}.`;
            const systemPrompt = QUESTION_SYSTEM_PROMPT(roleAppliedFor, interviewLog);

            const questionText = await callGemini("Question Generator", userQuery, null, systemPrompt);

            if (questionText && typeof questionText === 'string') {
                if (questionText.includes("INTERVIEW_COMPLETE")) {
                    endInterview(false);
                    return null;
                }
                return questionText.trim();
            }
            // Fallback for first question if API fails
            return currentQuestions === 0 ? "Tell me a little bit about yourself and why you are interested in the intern role at Internanda." : "Could you tell me about a time you faced a challenge and how you overcame it?";
        }

        async function evaluateAnswer(question, transcript) {
            const userQuery = `Candidate's answer: "${transcript}". Evaluate this answer against the question: "${question}".`;
            const systemPrompt = EVALUATION_SYSTEM_PROMPT(question, roleAppliedFor);

            const jsonString = await callGemini(systemPrompt, userQuery, EVALUATION_SCHEMA, "Answer Evaluator");

            try {
                // The API is instructed to return a strict JSON string, so we must parse it.
                const evaluation = JSON.parse(jsonString);
                // Ensure required fields are present
                if (typeof evaluation.score === 'number' && evaluation.summary) {
                    return evaluation;
                }
                throw new Error("Parsed JSON is incomplete.");
            } catch (e) {
                console.error("Failed to parse evaluation JSON:", jsonString, e);
                // Fallback score/evaluation if parsing fails
                return {
                    score: 5,
                    summary: "Evaluation failed due to malformed AI response. Score is a default 5.",
                    strengths: ["Spoke clearly."],
                    weaknesses: ["AI evaluation failed."],
                    deductions: ["Technical error: AI response was malformed."]
                };
            }
        }


        // --- INTERVIEW FLOW LOGIC ---

        async function interviewLoop() {
            if (!isInterviewActive || secondsRemaining <= 0) {
                endInterview(false);
                return;
            }

            const question = await generateQuestion();

            if (!question) return; // Interview ended by AI

            // 1. Interna speaks the question
            await speak(question);
            appendTranscript('interna', question);

            // 2. Candidate answers (listening starts after speaking ends)
            await speak(`Hello ${candidateName}, you may begin your answer now.`);
            
            // 3. Start listening and process the answer
            await startListening();
        }
        
        async function handleAnswer(transcript) {
            if (!isInterviewActive || !currentQuestion || !transcript.trim()) {
                // If transcript is empty, the startListening promise was likely resolved by no-speech detection
                if (transcript.trim() === "") {
                    // Already handled by startListening recursive call on empty transcript, so just wait
                    updateRobotState('idle');
                    return; 
                }
                // If critical data is missing, move to next question flow
                askNextQuestion();
                return;
            }

            updateRobotState('idle');
            // Log the candidate's transcribed answer
            appendTranscript('candidate', transcript);

            // 4. Evaluate the answer
            statusMessage.textContent = 'Analyzing response...';
            const evaluation = await evaluateAnswer(currentQuestion, transcript);
            appendEvaluation(evaluation);
            currentQuestion = null; // Clear question reference

            // 5. Speak a confirmation/transition and ask the next question
            let transitionPhrase = evaluation.score >= 7 
                ? "That's a strong response. Let's move on." 
                : "Thank you for your thoughts. Moving to the next area.";
            
            await speak(transitionPhrase);

            // Continue the loop
            interviewLoop();
        }

        async function startInterview() {
            candidateName = document.getElementById('candidate-name').value.trim() || "Candidate";
            roleAppliedFor = document.getElementById('role-applied-for').value.trim() || "Intern";
            
            if (!GEMINI_API_KEY) {
                alert("Please set the GEMINI_API_KEY in the script before starting the interview.");
                return;
            }

            // UI transition
            document.getElementById('intro-section').classList.add('hidden');
            document.getElementById('interview-section').classList.remove('hidden');
            
            isInterviewActive = true;
            interviewLog = [];
            currentQuestion = null;

            // Start Timer
            secondsRemaining = MAX_INTERVIEW_TIME_SECONDS;
            updateTimerDisplay();
            interviewTimer = setInterval(() => {
                secondsRemaining--;
                updateTimerDisplay();
                if (secondsRemaining <= 0) {
                    endInterview(false); // Time's up
                }
            }, 1000);

            // Initial greeting and first question
            const initialGreeting = `Hello ${candidateName}, welcome to the interview for the ${roleAppliedFor} role at Internanda. I am Interna. I will now ask you the first question.`;
            appendTranscript('interna', initialGreeting);

            // Start the main loop after the greeting
            await speak(initialGreeting);
            interviewLoop();
        }

        function endInterview(userInitiated) {
            if (!isInterviewActive) return;

            isInterviewActive = false;
            clearInterval(interviewTimer);
            if (speechRecognition) speechRecognition.abort();
            updateRobotState('idle');

            // Final message
            const finalMessage = userInitiated
                ? "The interview has been manually ended. Calculating results now."
                : (secondsRemaining <= 0 
                    ? "Time is up. The interview has ended. Calculating results."
                    : "The final question has been asked and answered. Calculating your overall score.");
            
            speak(finalMessage);
            appendTranscript('interna', finalMessage);

            // UI transition
            document.getElementById('interview-section').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            
            // Generate Results
            displayResults();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(secondsRemaining / 60);
            const seconds = secondsRemaining % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function displayResults() {
            const evaluations = interviewLog.filter(i => i.type === 'evaluation').map(i => i.data);
            if (evaluations.length === 0) {
                document.getElementById('final-score').textContent = "N/A";
                document.getElementById('final-verdict').textContent = "No questions were evaluated.";
                document.getElementById('final-verdict').className = "mt-4 text-xl font-bold text-slate-400";
                return;
            }

            const totalScore = evaluations.reduce((sum, e) => sum + e.score, 0);
            const finalScore = Math.round((totalScore / evaluations.length) * 10) / 10;
            const allDeductions = evaluations.flatMap(e => e.deductions).filter((value, index, self) => self.indexOf(value) === index); // Unique deductions

            // Display overall score and verdict
            const finalScoreEl = document.getElementById('final-score');
            const finalVerdictEl = document.getElementById('final-verdict');
            finalScoreEl.textContent = finalScore.toFixed(1);

            let verdictText, verdictColor;
            if (finalScore > 6.0) {
                verdictText = "Congratulations, you are selected! Your performance was excellent.";
                verdictColor = 'text-green-500';
            } else {
                verdictText = "Try Again — Improve using these suggestions. We encourage you to reapply.";
                verdictColor = 'text-red-500';
            }
            finalVerdictEl.textContent = verdictText;
            finalVerdictEl.className = `mt-4 text-xl font-bold ${verdictColor}`;

            // Display unique deduction reasons
            const deductionListEl = document.getElementById('deduction-list');
            deductionListEl.innerHTML = allDeductions.length > 0 
                ? allDeductions.map(d => `<li>${d}</li>`).join('') 
                : '<li>No significant recurring deductions noted.</li>';

            // Display detailed breakdown
            const breakdownPanel = document.getElementById('breakdown-panel');
            breakdownPanel.innerHTML = ''; // Clear previous content

            interviewLog.forEach((item, index) => {
                if (item.type === 'evaluation') {
                    const questionIndex = interviewLog.slice(0, index).filter(i => i.type === 'question').length;
                    const questionItem = interviewLog[index - 2]; // Q is before A, A is before E
                    const answerItem = interviewLog[index - 1];
                    const evalData = item.data;

                    const card = document.createElement('div');
                    card.className = 'glass-card p-4 bg-slate-800/80 space-y-3';
                    card.innerHTML = `
                        <h3 class="text-xl font-semibold text-accent">Question ${questionIndex}: ${questionItem ? questionItem.text : 'N/A'}</h3>
                        <p class="text-sm text-slate-400"><strong>Your Transcript:</strong> ${answerItem ? answerItem.text : 'N/A'}</p>
                        <div class="border-t border-slate-700 pt-3 space-y-2">
                            <h4 class="font-bold text-lg flex justify-between items-center">
                                Score:
                                <span class="text-3xl font-mono ${evalData.score >= 7 ? 'text-green-400' : evalData.score >= 4 ? 'text-yellow-400' : 'text-red-400'}">${evalData.score}/10</span>
                            </h4>
                            <p class="text-sm italic text-slate-300"><strong>Summary:</strong> ${evalData.summary}</p>
                            <div class="flex gap-4 text-sm">
                                <div>
                                    <h5 class="font-semibold text-green-300">Strengths:</h5>
                                    <ul class="list-disc list-inside text-green-200">
                                        ${evalData.strengths.map(s => `<li>${s}</li>`).join('')}
                                    </ul>
                                </div>
                                <div>
                                    <h5 class="font-semibold text-red-300">Deductions:</h5>
                                    <ul class="list-disc list-inside text-red-200">
                                        ${evalData.deductions.map(d => `<li class="text-red-400">${d}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                    breakdownPanel.appendChild(card);
                }
            });
            
            // Re-render icons on the results page
            lucide.createIcons();
        }

        // --- DOWNLOAD UTILITIES ---

        function getResultsObject() {
            const evaluations = interviewLog.filter(i => i.type === 'evaluation').map(i => i.data);
            const totalScore = evaluations.reduce((sum, e) => sum + e.score, 0);
            const finalScore = evaluations.length > 0 ? Math.round((totalScore / evaluations.length) * 10) / 10 : 0;
            const fullTranscript = interviewLog.map(item => {
                const prefix = item.type === 'question' ? 'Interna (Q): ' : item.type === 'answer' ? `${candidateName} (A): ` : 'Evaluation: ';
                return prefix + (item.text || JSON.stringify(item.data, null, 2));
            }).join('\n\n');
            
            const detailedBreakdown = interviewLog.map((item, index) => {
                 if (item.type === 'evaluation') {
                    const questionItem = interviewLog[index - 2];
                    const answerItem = interviewLog[index - 1];
                    return {
                        question: questionItem?.text,
                        candidateAnswer: answerItem?.text,
                        evaluation: item.data
                    };
                }
                return null;
            }).filter(i => i !== null);


            return {
                metadata: {
                    candidateName,
                    roleAppliedFor,
                    interviewDuration: MAX_INTERVIEW_TIME_SECONDS - secondsRemaining,
                    totalQuestions: evaluations.length,
                    finalScore,
                    timestamp: new Date().toISOString()
                },
                finalVerdict: finalScore > 6.0 ? "Selected" : "Try Again",
                breakdown: detailedBreakdown,
                fullInterviewLog: interviewLog,
                fullTranscript: fullTranscript
            };
        }

        function downloadResults(type) {
            const results = getResultsObject();
            const filenameBase = `Internanda_Interview_Result_${candidateName.replace(/\s/g, '_')}`;

            if (type === 'json') {
                const json = JSON.stringify(results, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filenameBase}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else if (type === 'pdf') {
                // Use browser's print functionality for PDF generation (with custom CSS for clean output)
                window.print();
            }
        }

        // Initialize voices when they are loaded
        window.speechSynthesis.onvoiceschanged = function() {
            // Voices loaded
            console.log("Speech synthesis voices loaded.");
        };

        // --- INITIALIZATION ---
        // Ensure initial state is set up for the UI
        document.addEventListener('DOMContentLoaded', () => {
             // Sign in logic (required by Canvas, even if not used for persistence)
            // Note: Since Firestore dependencies are not included, this is only a placeholder for auth setup.
             console.log("Canvas Auth Initialized Placeholder.");
        });

    </script>
</body>
</html>
